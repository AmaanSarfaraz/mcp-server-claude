# MCP Server - ConnectSafely API Configuration

## Project Overview

This is an MCP (Model Context Protocol) server that provides tools for interacting with the ConnectSafely LinkedIn API. The server exposes LinkedIn automation capabilities through MCP tools.

## Architecture

- **Type**: MCP Server (Model Context Protocol)
- **Language**: TypeScript (ES2022, Node16 modules)
- **Transport**: Supports both stdio and StreamableHTTP transports
- **Framework**: Uses Hono for HTTP server, MCP SDK for protocol implementation

## Key Files

- `src/index.ts` - Main MCP server implementation with tool definitions
- `src/streamable-http.ts` - HTTP transport setup using Hono
- `package.json` - Project dependencies and scripts
- `tsconfig.json` - TypeScript configuration

## Code Style & Conventions

### TypeScript

- Use strict mode with `noImplicitAny` and `strictNullChecks`
- Use ES modules (`type: "module"` in package.json)
- Target ES2022, Node16 module resolution
- Always include type annotations for function parameters and return types
- Use interfaces for object shapes, types for unions/intersections

### Error Handling

- Use try-catch blocks for async operations
- Format API errors using `formatApiError()` function
- Log errors to stderr (console.error) to avoid interfering with MCP output
- Return structured error messages in MCP response format

### Security

- API keys and tokens are loaded from environment variables via dotenv
- Bearer tokens: `BEARER_TOKEN_BEARERAUTH`
- Never hardcode credentials in source code
- Security schemes are defined in the OpenAPI spec and applied automatically

### MCP Tool Definitions

- Tools are defined in `toolDefinitionMap` with:
  - `name`: Tool identifier
  - `description`: Human-readable description
  - `inputSchema`: JSON Schema for validation
  - `method`: HTTP method (get, post, etc.)
  - `pathTemplate`: API endpoint path
  - `executionParameters`: Path/query/header parameters
  - `requestBodyContentType`: Content type for request body
  - `securityRequirements`: Required authentication schemes

### API Integration

- Base URL: `https://api.connectsafely.ai`
- Uses axios for HTTP requests
- Request validation via Zod schemas (converted from JSON Schema)
- Response formatting: JSON.stringify with indentation for readability

### HTTP Transport

- Default port: 3000
- Endpoints:
  - `POST /mcp` - Main MCP communication endpoint
  - `GET /health` - Health check endpoint
  - `GET /*` - Static file serving from `public/` directory
- Session management via `mcp-session-id` header
- CORS enabled for all routes

## Development Guidelines

### Adding New Tools

1. Add tool definition to `toolDefinitionMap` in `src/index.ts`
2. Include proper input schema with validation rules
3. Specify security requirements if authentication is needed
4. Test with both stdio and HTTP transports

### Environment Variables

- Create `.env` file for local development
- Required for bearer auth: `BEARER_TOKEN_BEARERAUTH`
- OAuth2: `OAUTH_CLIENT_ID_*`, `OAUTH_CLIENT_SECRET_*`, `OAUTH_SCOPES_*`
- API Keys: `API_KEY_*` (scheme name in uppercase with underscores)

### Building & Running

- `npm run build` - Compile TypeScript to `build/` directory
- `npm start` - Build and run with stdio transport
- `npm run start:http` - Build and run with StreamableHTTP transport
- `npm run typecheck` - Type check without emitting

### Testing

- Jest configured for TypeScript/ESM
- Test files should be in `*.test.ts` format
- Use `ts-jest` preset with ESM support

## Common Patterns

### Tool Execution Flow

1. Validate arguments against Zod schema
2. Resolve path parameters, query params, headers
3. Apply security (bearer tokens, API keys, OAuth)
4. Make HTTP request via axios
5. Format response as MCP content

### Schema Validation

- JSON Schema â†’ Zod conversion via `json-schema-to-zod`
- Validation errors include field paths and error codes
- Passthrough schema used as fallback for invalid schemas

### Security Application

- Security schemes checked in order (OR between requirements, AND within)
- Bearer tokens: `Authorization: Bearer <token>`
- API keys: Header, query, or cookie based on scheme definition
- OAuth2: Supports client credentials flow with token caching

## Best Practices

- Keep tool descriptions clear and include parameter details
- Use descriptive variable names
- Add console.error logs for debugging (they go to stderr)
- Handle edge cases (empty responses, network errors, etc.)
- Maintain backward compatibility when updating tool schemas
- Document any breaking changes in tool definitions

## Dependencies

- `@modelcontextprotocol/sdk` - MCP protocol implementation
- `axios` - HTTP client
- `zod` - Runtime validation
- `json-schema-to-zod` - Schema conversion
- `hono` - Web framework for HTTP transport
- `dotenv` - Environment variable management
